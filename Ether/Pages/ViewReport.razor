@page "/reports/view/{type}/{id:guid}"
@inject EtherClient Client
@inject IUriHelper UriHelper
@inject JsUtils JsUtils

<Ether.Components.Card>
    <Header>
        @reportDisplayName
        <div class="d-print-none pull-right d-print-none">
            @if (excelConverter != null)
            {
                <button class="btn btn-fill btn-primary" onclick="@ExportToExcel">Export to Excel</button>
            }
            <button class="btn btn-fill btn-secondary" onclick="@Print">Print</button>
            <button class="btn btn-fill btn-info" onclick="@NewReport">New report</button>
            <button class="btn btn-fill btn-success" onclick="@BackToList">Back to list</button>
        </div>
    </Header>
    <Body>
        @componentToRender
    </Body>
    <Footer></Footer>
</Ether.Components.Card>
@functions
{
    private string reportDisplayName = string.Empty;
    private Types.Excel.ReportToExcelConverter excelConverter = null;
    private RenderFragment componentToRender;
    private ReportViewModel report;

    [Parameter]
    private Guid? Id { get; set; }

    [Parameter]
    private string Type { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        // TODO: that is not going to fly
        if (string.Equals(Type, "PullRequestsReport", StringComparison.OrdinalIgnoreCase))
        {
            reportDisplayName = "Pull requests report";
            report = await Client.GetById<PullRequestReportViewModel>(Id.Value);
            excelConverter = new Types.Excel.PullRequestsReportToExcelConverter();
            componentToRender = b => RenderComponent<Ether.Components.Reports.PullRequestsReport>(b);
        }
        else if (string.Equals(Type, "AggregatedWorkitemsETAReport", StringComparison.OrdinalIgnoreCase))
        {
            reportDisplayName = "Aggregated workitems ETA report";
            report = await Client.GetById<AggregatedWorkitemsETAReportViewModel>(Id.Value);
            excelConverter = null;
            componentToRender = b => RenderComponent<Ether.Components.Reports.AggregatedWorkitemsETAReport>(b);
        }
        else if (string.Equals(Type, "WorkitemsReporter", StringComparison.OrdinalIgnoreCase))
        {
            reportDisplayName = "Workitems report";
            report = await Client.GetById<WorkItemsReportViewModel>(Id.Value);
            excelConverter = new Types.Excel.WorkItemsReportToExcelConverter();
            componentToRender = b => RenderComponent<Ether.Components.Reports.WorkitemsReport>(b);
        }
    }

    protected void RenderComponent<T>(Microsoft.AspNetCore.Components.RenderTree.RenderTreeBuilder builder)
        where T : IComponent
    {
        builder.OpenComponent<T>(1);
        builder.AddAttribute(2, "Id", Id.Value);
        builder.AddAttribute(3, "Report", report);
        builder.CloseComponent();
    }

    protected void BackToList()
    {
        UriHelper.NavigateTo("/reports");
    }

    protected void NewReport()
    {
        UriHelper.NavigateTo("/");
    }

    protected void Print()
    {
        JsUtils.Print();
    }

    protected async Task ExportToExcel()
    {
        var excelReport = excelConverter.Convert(report);
        var base64EncodedReport = Convert.ToBase64String(excelReport);
        await JsUtils.SaveAsFile("report.xlsx", base64EncodedReport);
    }
}
