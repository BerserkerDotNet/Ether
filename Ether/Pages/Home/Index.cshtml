@page
@model Ether.Pages.Home.IndexModel
@inject IEnumerable<IReporter> Reporters
@inject IAll<Profile> Profiles

@{
    var allProfiles = Profiles.Value.Select(p => new SelectListItem { Text = p.Name, Value = p.Id.ToString() });
    var allReporters = Reporters.Select(r => new SelectListItem { Text = r.Name, Value = r.Id.ToString() });
}

<h2>@ViewData["Title"]</h2>

<form asp-page-handler="Report" method="post">
    <div asp-validation-summary="All" class="text-danger"></div>
    <div class="form-group">
        <fieldset>
            <legend>Select profiles</legend>

            @foreach (var profile in Profiles.Value)
            {
                <label for="repo-@profile.Id">@profile.Name</label>
                <input type="checkbox" name="ReportRequest.Profiles" value="@profile.Id" id="repo-@profile.Id" @(Model.ReportRequest.Profiles != null && Model.ReportRequest.Profiles.Contains(profile.Id) ? "checked" : "") />
            }
        </fieldset>
        <span asp-validation-for="ReportRequest.Profiles" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="ReportRequest.Report">Report:</label>
        <select asp-for="ReportRequest.Report" asp-items="@allReporters" class="form-control"></select>
        <span asp-validation-for="ReportRequest.Report" class="text-danger"></span>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label id="StartDateLabel" asp-for="ReportRequest.StartDate">Start date:</label>
                <div id="StartDateDiv"></div>
                <input id="StartDate" asp-for="ReportRequest.StartDate" type="hidden" />
                <span asp-validation-for="ReportRequest.StartDate" class="text-danger"></span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label id="EndDateLabel" asp-for="ReportRequest.EndDate">End date:</label>
                <div id="EndDateDiv"></div>
                <input id="EndDate" asp-for="ReportRequest.EndDate" type="hidden" />
                <span asp-validation-for="ReportRequest.EndDate" class="text-danger"></span>
            </div>
        </div>
    </div>
    <button id="generateReportBtn" type="submit" class="btn btn-success">Create a report</button>
</form>

<div id="loadingModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Generating report</h4>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="progressBar" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                        <span class="sr-only">Your report is being generated, please wait&hellip;</span>
                    </div>
                </div>
                <p>Your report is being generated, please wait&hellip;</p>
                <textarea id="progressReport" readonly style="resize:none; width:100%; height:200px;"></textarea>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
@section Scripts{
    <script type="text/javascript" src="~/lib/signalr/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            $('input[type="checkbox"]').checkboxradio({
                icon: true
            });
            configureDateSelectors();
            var currentProgress = 0;
            $('form').submit(function (e) {
                if ($(this).valid()) {
                    currentProgress = 0;
                    $('#loadingModal').modal({
                        keyboard: false,
                        backdrop: 'static'
                    });
                }
            });

            var connection = new signalR.HubConnection('/liveupdates', { transport: signalR.TransportType.LongPolling });
            connection.on('update', function (message, moveProgressBy) {
                console.log('received: ' + message + '; progress update: ' + moveProgressBy);
                var reportArea = $('#progressReport');
                reportArea.append(message + '\n');
                reportArea.scrollTop(reportArea[0].scrollHeight);
                var totalWidth = $('.progress').width();
                var moveBy = (totalWidth * moveProgressBy) / 100;
                var bar = $('#progressBar');
                currentProgress = currentProgress + moveBy;
                bar.width(currentProgress);
                var currentPercent = Math.round((currentProgress * 100) / totalWidth);
                bar.attr('aria-valuenow', currentPercent);
                bar.text(currentPercent + '%')
                console.log('Total width: ' + totalWidth + '; moveBy: ' + moveBy + '; updated width: ' + currentProgress);
            });

            connection.on('reset', function () {
                console.log('reseting progress');
                currentProgress = 0;
                var bar = $('#progressBar');
                bar.width(currentProgress);
                bar.attr('aria-valuenow', 0);
                bar.text(0 + '%')
            });

            connection.start();

        });
        function setSelectedStartDate(date) {
            $('#StartDateLabel').text('Start date (' + date + '):');
        }

        function setSelectedEndDate(date) {
            $('#EndDateLabel').text('End date (' + date + '):');
        }

        function configureDateSelectors() {
            var commonOptions = {
                changeMonth: true,
                changeYear: true,
                minDate: "-6M",
                maxDate: "+1D",
                numberOfMonths: 2,
            };

            var startDateOptions = $.extend({
                defaultDate: "-1W",
                altField: "#StartDate",
                onSelect: function (date) {
                    setSelectedStartDate(date);
                }
            }, commonOptions);
            var startDate = $('#StartDateDiv').datepicker(startDateOptions);

            var endDateOptions = $.extend({
                defaultDate: "+1D",
                altField: "#EndDate",
                onSelect: function (date) {
                    setSelectedEndDate(date);
                }
            }, commonOptions);
            var endDate = $('#EndDateDiv').datepicker(endDateOptions);
            setSelectedStartDate(startDate.datepicker("getDate").toLocaleDateString());
            setSelectedEndDate(endDate.datepicker("getDate").toLocaleDateString());
        }

    </script>
}